FROM python:3.12-slim

WORKDIR /app

# Installer les d√©pendances syst√®me n√©cessaires
RUN apt-get update && apt-get install -y \
    tesseract-ocr \
    tesseract-ocr-fra \
    poppler-utils \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Mettre √† jour pip avec timeout augment√© et retries
RUN pip install --no-cache-dir --upgrade pip setuptools wheel --timeout=300 --retries=5

# Copier d'abord requirements.txt pour utiliser le cache Docker
COPY backend/requirements.txt .

# Installer les d√©pendances Python avec gestion d'erreurs robuste
# Options pour g√©rer les probl√®mes de connexion r√©seau (BrokenPipeError) :
# - timeout augment√© (600 secondes = 10 minutes)
# - retries (10 tentatives)
# - Installation avec plusieurs tentatives et pauses
RUN set -e; \
    for i in 1 2 3; do \
        echo "üîÑ Tentative d'installation $i/3..." && \
        pip install --no-cache-dir \
            --timeout=600 \
            --retries=10 \
            --default-timeout=600 \
            --progress-bar off \
            -r requirements.txt && \
        echo "‚úÖ Installation r√©ussie !" && \
        break || \
        (echo "‚ö†Ô∏è Tentative $i √©chou√©e, attente 15 secondes avant nouvelle tentative..." && \
         sleep 15); \
    done || \
    (echo "‚ùå Erreur : Impossible d'installer les d√©pendances apr√®s 3 tentatives" && exit 1)

# Nettoyer le cache pip apr√®s installation pour r√©duire la taille
RUN pip cache purge && \
    rm -rf /root/.cache/pip

# Copier uniquement les fichiers n√©cessaires (exclut data/ via .dockerignore)
COPY backend/ .

# Cr√©er les dossiers n√©cessaires avec permissions
RUN mkdir -p storage/vector_store data phoenix_data && \
    chmod -R 755 storage data phoenix_data

# V√©rifier que les fichiers essentiels existent
RUN test -f run_api.py || (echo "run_api.py manquant" && exit 1) && \
    test -d app || (echo "dossier app/ manquant" && exit 1)

# Nettoyer les fichiers inutiles pour r√©duire la taille
RUN find . -type d -name "__pycache__" -exec rm -r {} + 2>/dev/null || true && \
    find . -type f -name "*.pyc" -delete && \
    find . -type f -name "*.pyo" -delete

# Exposer le port de l'API (Render utilise PORT dynamiquement)
EXPOSE 8001

# Healthcheck (Render utilise PORT dynamiquement, mais healthcheck utilise 8001 par d√©faut)
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:8001/health || exit 1

# Commande par d√©faut
CMD ["python", "run_api.py"]

